"AWSTemplateFormatVersion: \"2010-09-09\"\nDescription: \"ECS Fargate + API Gateway REST API with API Key for Books Management\"\n\nParameters:\n  ImageName:\n    Type: String\n    Description: ECR Image Name\n    Default: books-app:latest\n\n  VpcId:\n    Type: AWS::EC2::VPC::Id\n    Description: VPC\n\n  SubnetIds:\n    Type: List<AWS::EC2::Subnet::Id>\n    Description: At least 2 Subnets\n\n  DBType:\n    Type: String\n    Default: dynamodb\n    AllowedValues:\n      - dynamodb\n\n \n  DBDynamoName:\n    Type: String\n    Default: \"books\"\n    Description: DynamoDB table name\n\n# ============================================================================\n# NETWORKING RESOURCES\n# ============================================================================\nResources:\n  ECSSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Security group for ECS tasks\n      VpcId: !Ref VpcId\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 8080\n          ToPort: 8080\n          CidrIp: 0.0.0.0/0\n\n  # ============================================================================\n  # LOAD BALANCER RESOURCES\n  # ============================================================================\n  NLB:\n    Type: AWS::ElasticLoadBalancingV2::LoadBalancer\n    Properties:\n      Name: books-nlb\n      Type: network\n      Scheme: internal\n      Subnets: !Ref SubnetIds\n\n  TargetGroup:\n    Type: AWS::ElasticLoadBalancingV2::TargetGroup\n    Properties:\n      Name: books-tg\n      Port: 8080\n      Protocol: TCP\n      VpcId: !Ref VpcId\n      TargetType: ip\n      HealthCheckProtocol: HTTP\n      HealthCheckPath: /health\n      HealthCheckIntervalSeconds: 30\n      HealthCheckTimeoutSeconds: 5\n      HealthyThresholdCount: 2\n      UnhealthyThresholdCount: 3\n\n  Listener:\n    Type: AWS::ElasticLoadBalancingV2::Listener\n    Properties:\n      DefaultActions:\n        - Type: forward\n          TargetGroupArn: !Ref TargetGroup\n      LoadBalancerArn: !Ref NLB\n      Port: 8080\n      Protocol: TCP\n\n  # ============================================================================\n  # ECS RESOURCES\n  # ============================================================================\n  ECSCluster:\n    Type: AWS::ECS::Cluster\n    Properties:\n      ClusterName: books-cluster\n\n  TaskDefinition:\n    Type: AWS::ECS::TaskDefinition\n    Properties:\n      Family: books-task\n      NetworkMode: awsvpc\n      RequiresCompatibilities:\n        - FARGATE\n      Cpu: 256\n      Memory: 512\n      ExecutionRoleArn: !Sub \"arn:aws:iam::${AWS::AccountId}:role/LabRole\"\n      TaskRoleArn: !Sub \"arn:aws:iam::${AWS::AccountId}:role/LabRole\"\n      ContainerDefinitions:\n        - Name: books-container\n          Image: !Sub \"${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ImageName}\"\n          PortMappings:\n            - ContainerPort: 8080\n              Protocol: tcp\n          LogConfiguration:\n            LogDriver: awslogs\n            Options:\n              awslogs-group: /ecs/books\n              awslogs-region: !Ref AWS::Region\n              awslogs-stream-prefix: books\n              awslogs-create-group: \"true\"\n          Environment:\n            - Name: DB_TYPE\n              Value: !Ref DBType\n            - Name: DB_DYNAMONAME\n              Value: !Ref DBDynamoName\n\n  ECSService:\n    Type: AWS::ECS::Service\n    DependsOn:\n      - Listener\n    Properties:\n      Cluster: !Ref ECSCluster\n      ServiceName: books-service\n      TaskDefinition: !Ref TaskDefinition\n      DesiredCount: 1\n      LaunchType: FARGATE\n      NetworkConfiguration:\n        AwsvpcConfiguration:\n          AssignPublicIp: ENABLED # se cambio, comporbar que fucniona \n          Subnets: !Ref SubnetIds\n          SecurityGroups:\n            - !Ref ECSSecurityGroup\n      LoadBalancers:\n        - ContainerName: books-container\n          ContainerPort: 8080\n          TargetGroupArn: !Ref TargetGroup\n\n  # ============================================================================\n  # API GATEWAY RESOURCES\n  # ============================================================================\n  VPCLink:\n    Type: AWS::ApiGateway::VpcLink\n    Properties:\n      Name: books-vpc-link\n      TargetArns:\n        - !Ref NLB\n\n  RestAPI:\n    Type: AWS::ApiGateway::RestApi\n    Properties:\n      Name: books-api\n      Description: API for Books Management\n\n  BooksResource:\n    Type: AWS::ApiGateway::Resource\n    Properties:\n      RestApiId: !Ref RestAPI\n      ParentId: !GetAtt RestAPI.RootResourceId\n      PathPart: books\n\n  BookResource:\n    Type: AWS::ApiGateway::Resource\n    Properties:\n      RestApiId: !Ref RestAPI\n      ParentId: !Ref BooksResource\n      PathPart: \"{id}\"\n\n  PostBooksMethod:\n    Type: AWS::ApiGateway::Method\n    Properties:\n      RestApiId: !Ref RestAPI\n      ResourceId: !Ref BooksResource\n      HttpMethod: POST\n      AuthorizationType: NONE\n      ApiKeyRequired: false #se cambio para pruebas\n      Integration:\n        Type: HTTP_PROXY\n        IntegrationHttpMethod: POST\n        Uri: !Sub \"http://${NLB.DNSName}:8080/books\"\n        ConnectionType: VPC_LINK\n        ConnectionId: !Ref VPCLink\n        \n  GetBooksMethod:\n    Type: AWS::ApiGateway::Method\n    Properties:\n      RestApiId: !Ref RestAPI\n      ResourceId: !Ref BooksResource\n      HttpMethod: GET\n      AuthorizationType: NONE\n      ApiKeyRequired: false #se cambio para prueabs\n      Integration:\n        Type: HTTP_PROXY\n        IntegrationHttpMethod: GET\n        Uri: !Sub \"http://${NLB.DNSName}:8080/books\"\n        ConnectionType: VPC_LINK\n        ConnectionId: !Ref VPCLink\n\n  GetBookMethod:\n    Type: AWS::ApiGateway::Method\n    Properties:\n      RestApiId: !Ref RestAPI\n      ResourceId: !Ref BookResource\n      HttpMethod: GET\n      AuthorizationType: NONE\n      ApiKeyRequired: false #se cambio para prueabs\n      RequestParameters:\n        method.request.path.id: true\n      Integration:\n        Type: HTTP_PROXY\n        IntegrationHttpMethod: GET\n        Uri: !Sub \"http://${NLB.DNSName}:8080/books/{id}\"\n        ConnectionType: VPC_LINK\n        ConnectionId: !Ref VPCLink\n        RequestParameters:\n          integration.request.path.id: method.request.path.id\n\n  PutBookMethod:\n    Type: AWS::ApiGateway::Method\n    Properties:\n      RestApiId: !Ref RestAPI\n      ResourceId: !Ref BookResource\n      HttpMethod: PUT\n      AuthorizationType: NONE\n      ApiKeyRequired: false #se cambio para prueabs\n      RequestParameters:\n        method.request.path.id: true\n      Integration:\n        Type: HTTP_PROXY\n        IntegrationHttpMethod: PUT\n        Uri: !Sub \"http://${NLB.DNSName}:8080/books/{id}\"\n        ConnectionType: VPC_LINK\n        ConnectionId: !Ref VPCLink\n        RequestParameters:\n          integration.request.path.id: method.request.path.id\n\n  DeleteBookMethod:\n    Type: AWS::ApiGateway::Method\n    Properties:\n      RestApiId: !Ref RestAPI\n      ResourceId: !Ref BookResource\n      HttpMethod: DELETE\n      AuthorizationType: NONE\n      ApiKeyRequired: false #se cambio para prueabs\n      RequestParameters:\n        method.request.path.id: true\n      Integration:\n        Type: HTTP_PROXY\n        IntegrationHttpMethod: DELETE\n        Uri: !Sub \"http://${NLB.DNSName}:8080/books/{id}\"\n        ConnectionType: VPC_LINK\n        ConnectionId: !Ref VPCLink\n        RequestParameters:\n          integration.request.path.id: method.request.path.id\n\n  OptionsBooksMethod:\n    Type: AWS::ApiGateway::Method\n    Properties:\n      RestApiId: !Ref RestAPI\n      ResourceId: !Ref BooksResource\n      HttpMethod: OPTIONS\n      AuthorizationType: NONE\n      ApiKeyRequired: false\n      Integration:\n        Type: MOCK\n        IntegrationResponses:\n          - StatusCode: 200\n            ResponseParameters:\n              method.response.header.Access-Control-Allow-Origin: \"'*'\"\n              method.response.header.Access-Control-Allow-Methods: \"'GET,POST,PUT,DELETE,OPTIONS'\"\n              method.response.header.Access-Control-Allow-Headers: \"'Content-Type,x-api-key'\"\n        RequestTemplates:\n          application/json: '{\"statusCode\": 200}'\n      MethodResponses:\n        - StatusCode: 200\n          ResponseParameters:\n            method.response.header.Access-Control-Allow-Headers: true\n            method.response.header.Access-Control-Allow-Methods: true\n            method.response.header.Access-Control-Allow-Origin: true\n\n  OptionsBookMethod:\n    Type: AWS::ApiGateway::Method\n    Properties:\n      RestApiId: !Ref RestAPI\n      ResourceId: !Ref BookResource\n      HttpMethod: OPTIONS\n      AuthorizationType: NONE\n      ApiKeyRequired: false\n      Integration:\n        Type: MOCK\n        IntegrationResponses:\n          - StatusCode: 200\n            ResponseParameters:\n             method.response.header.Access-Control-Allow-Origin: \"'*'\"\n             method.response.header.Access-Control-Allow-Methods: \"'GET,POST,PUT,DELETE,OPTIONS'\"\n             method.response.header.Access-Control-Allow-Headers: \"'Content-Type,x-api-key'\"\n        RequestTemplates:\n          application/json: '{\"statusCode\": 200}'\n      MethodResponses:\n        - StatusCode: 200\n          ResponseParameters:\n            method.response.header.Access-Control-Allow-Headers: true\n            method.response.header.Access-Control-Allow-Methods: true\n            method.response.header.Access-Control-Allow-Origin: true\n\n\n  APIDeployment:\n    Type: AWS::ApiGateway::Deployment\n    DependsOn:\n      - PostBooksMethod\n      - GetBooksMethod\n      - GetBookMethod\n      - PutBookMethod\n      - DeleteBookMethod\n      - OptionsBooksMethod\n      - OptionsBookMethod\n    Properties:\n      RestApiId: !Ref RestAPI\n\n  APIStage:\n    Type: AWS::ApiGateway::Stage\n    Properties:\n      RestApiId: !Ref RestAPI\n      DeploymentId: !Ref APIDeployment\n      StageName: prod\n\n  APIKey:\n    Type: AWS::ApiGateway::ApiKey\n    Properties:\n      Name: books-api-key\n      Enabled: true\n\n  UsagePlan:\n    Type: AWS::ApiGateway::UsagePlan\n    DependsOn: APIStage\n    Properties:\n      UsagePlanName: books-usage-plan\n      ApiStages:\n        - ApiId: !Ref RestAPI\n          Stage: !Ref APIStage\n\n  UsagePlanKey:\n    Type: AWS::ApiGateway::UsagePlanKey\n    Properties:\n      KeyId: !Ref APIKey\n      KeyType: API_KEY\n      UsagePlanId: !Ref UsagePlan\n\n# ============================================================================\n# OUTPUTS\n# ============================================================================\nOutputs:\n  APIEndpoint:\n    Description: API Gateway URL\n    Value: !Sub \"https://${RestAPI}.execute-api.${AWS::Region}.amazonaws.com/prod\"\n\n  APIKeyId:\n    Description: API Key ID\n    Value: !Ref APIKey"
